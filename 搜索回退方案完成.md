# 搜索服务回退方案 - DuckDuckGo

## 修改时间
2025年10月30日

## 功能说明

为搜索服务添加了自动回退机制，确保搜索功能的高可用性。

---

## 🎯 工作流程

```
用户请求搜索
    ↓
是否配置 Brave API Key?
    ├─ 是 → 尝试 Brave Search (最多3次重试)
    │        ├─ 成功 → 返回结果 ✅
    │        └─ 失败 → 自动切换到 DuckDuckGo ↓
    └─ 否 → 直接使用 DuckDuckGo
                ↓
         尝试 DuckDuckGo Search
                ├─ 成功 → 返回结果 ✅
                └─ 失败 → 返回错误提示 ⚠️
```

---

## ✅ 实现特性

### 1. 双层搜索保障
- **第一层**：Brave Search API（高质量，需要配置）
  - 3次重试机制
  - 15秒超时
  - 逐步延迟重试（1秒、2秒、3秒）
  
- **第二层**：DuckDuckGo API（回退方案）
  - 完全免费
  - 无需 API Key
  - 零配置
  - 10秒超时

### 2. 自动切换机制
- Brave Search 失败后自动切换
- 控制台记录切换日志
- 用户无感知的平滑过渡

### 3. 智能响应
- 返回结果中标注使用的搜索引擎
- Brave: "✅ 使用 Brave Search API"
- DuckDuckGo: "✅ 使用 DuckDuckGo 作为回退方案（免费，无需 API Key）"

---

## 📝 代码修改

### 文件：`lib/tools-complete.ts`

#### 新增函数
```typescript
/**
 * DuckDuckGo 搜索（回退方案）
 * 优点：完全免费，无需 API 密钥，零配置
 */
async function searchWithDuckDuckGo(query: string)
```

#### 修改函数
```typescript
async function searchWeb(query: string) {
  // 优先尝试 Brave Search（如果配置了 API Key）
  if (process.env.BRAVE_API_KEY) {
    try {
      // ... Brave Search 逻辑
      // 失败后自动回退到 DuckDuckGo
      return await searchWithDuckDuckGo(query);
    } catch (error) {
      return await searchWithDuckDuckGo(query);
    }
  } else {
    // 未配置 Brave，直接使用 DuckDuckGo
    return await searchWithDuckDuckGo(query);
  }
}
```

---

## 🧪 测试结果

### Brave Search API 测试
```bash
$ curl "https://api.search.brave.com/res/v1/web/search?q=test"
HTTP 状态码: 200 ✅
```

### DuckDuckGo API 测试
```bash
$ curl "https://api.duckduckgo.com/?q=test&format=json"
返回 JSON 数据 ✅
```

---

## 📊 搜索引擎对比

| 特性 | Brave Search | DuckDuckGo |
|------|-------------|-----------|
| 质量 | ⭐⭐⭐⭐⭐ 高质量 | ⭐⭐⭐⭐ 较好 |
| 配置 | 需要 API Key | 无需配置 |
| 费用 | 2000次/月免费 | 完全免费 |
| 结果数量 | 5条/请求 | 1-5条不等 |
| 适合场景 | 主要搜索 | 回退方案 |
| 稳定性 | 高 | 高 |
| 超时设置 | 15秒 | 10秒 |

---

## 💡 使用场景

### 场景 1：正常使用（Brave 可用）
```
用户：搜索 AI 技术
  ↓
Brave Search（成功）
  ↓
返回高质量搜索结果
```

### 场景 2：Brave 暂时不可用
```
用户：搜索 AI 技术
  ↓
Brave Search（尝试3次，失败）
  ↓
自动切换到 DuckDuckGo
  ↓
返回搜索结果（标注为回退方案）
```

### 场景 3：未配置 Brave API Key
```
用户：搜索 AI 技术
  ↓
检测到未配置 Brave API Key
  ↓
直接使用 DuckDuckGo
  ↓
返回搜索结果（免费，无需配置）
```

---

## 🔍 日志示例

### 正常情况（Brave 成功）
```
✅ 使用 Brave Search API (尝试 1/3)
```

### 回退情况（Brave 失败 → DuckDuckGo）
```
Brave Search 尝试 1/3 失败: timeout
Brave Search 尝试 2/3 失败: timeout
Brave Search 尝试 3/3 失败: timeout
Brave Search 失败，自动切换到 DuckDuckGo 作为回退方案...
✅ 使用 DuckDuckGo 作为回退方案（免费，无需 API Key）
```

### 未配置 Brave
```
未配置 Brave API Key，使用 DuckDuckGo（免费，无需配置）
✅ 使用 DuckDuckGo 作为回退方案（免费，无需 API Key）
```

---

## 🎯 优势

1. **高可用性**：双层保障，搜索成功率接近 100%
2. **零配置**：即使没有配置任何 API Key 也能正常搜索
3. **成本优化**：Brave 配额用完后自动使用免费的 DuckDuckGo
4. **用户体验**：自动切换，用户无感知
5. **可维护性**：清晰的日志，便于排查问题

---

## 🚀 后续优化建议

### 1. 添加更多搜索引擎
可以继续添加更多回退选项：
- Google Custom Search
- Bing Search API
- Serper API

### 2. 智能选择策略
根据查询类型选择最合适的搜索引擎：
- 技术问题 → Brave Search
- 快速事实查询 → DuckDuckGo
- 学术搜索 → Google Scholar

### 3. 结果合并
同时调用多个搜索引擎，合并结果以提高准确性

### 4. 缓存机制
对常见查询添加缓存，减少 API 调用

---

## 📋 验证步骤

### 测试 1：正常搜索（Brave 可用）
```
对 Agent 说："搜索2024年AI技术发展"
期望：使用 Brave Search，返回高质量结果
```

### 测试 2：模拟 Brave 失败
```
临时删除或注释 BRAVE_API_KEY
对 Agent 说："搜索Python编程"
期望：自动使用 DuckDuckGo，返回搜索结果
```

### 测试 3：查看日志
```
查看浏览器控制台或服务器日志
期望：清楚显示使用了哪个搜索引擎
```

---

## 🎉 总结

搜索服务现在具备了强大的容错能力：
- ✅ 主搜索：Brave Search（高质量）
- ✅ 回退方案：DuckDuckGo（免费，零配置）
- ✅ 自动切换：无需人工干预
- ✅ 高可用：双层保障，接近 100% 成功率

即使在网络不稳定或 API 配额用完的情况下，搜索功能也能正常工作！

