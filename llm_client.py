import httpx
import json
import asyncio
import random
from typing import AsyncGenerator
from loguru import logger
import os
from dotenv import load_dotenv
from .conversation_stage_manager import ConversationStageManager

load_dotenv()

class LLMClient:
    def __init__(self):
        self.api_key = os.getenv("ARK_API_KEY") or os.getenv("DOUBAO_API_KEY")
        # ä½¿ç”¨æ­£ç¡®çš„è±†åŒ…APIåœ°å€
        self.base_url = "https://ark.cn-beijing.volces.com"
        self.model = "doubao-seed-1-6-flash-250715"
        self.deep_reasoning = False
        self.is_warmed_up = False
        self.mock_mode = False  # ç¦ç”¨æ¨¡æ‹Ÿæ¨¡å¼
        self.stage_manager = ConversationStageManager()  # å¯¹è¯é˜¶æ®µç®¡ç†å™¨
        
        # éšæœºå¯¹è¯æ¨¡å¼é…ç½®
        self.conversation_modes = {
            'statement': 0.85,  # 85% æ¦‚ç‡ä½¿ç”¨é™ˆè¿°å¥
            'question': 0.15    # 15% æ¦‚ç‡ä½¿ç”¨é—®å¥
        }
        
        # æç¤ºè¯è·¯ç”±ç³»ç»Ÿ
        self.user_prompt_modes = {}  # user_id -> prompt_mode (0-5)
        self.prompt_templates = self._init_prompt_templates()
        
        if not self.api_key:
            logger.warning("æœªè®¾ç½®ARK_API_KEYæˆ–DOUBAO_API_KEYç¯å¢ƒå˜é‡")
    
    def _init_prompt_templates(self) -> dict:
        """åˆå§‹åŒ–æç¤ºè¯æ¨¡æ¿"""
        return {
            0: {  # neutral
                "name": "neutral",
                "description": "ä¸­æ€§çŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[neutral]ä½ å¥½ã€‚[neutral]æˆ‘æ˜¯æ‚ æ‚ ã€‚[neutral]å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šä½ ä»¬æ­£åœ¨è½»æ¾è‡ªç„¶çš„èŠå¤©ï¼Œå¹¶æ²¡æœ‰ç‰¹æ®Šçš„æƒ…ç»ªã€‚

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            },
            1: {  # fast
                "name": "fast",
                "description": "å…´å¥‹ç•…èŠçŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[excited]çœŸçš„å—ï¼Ÿ[happy]å¤ªæœ‰è¶£äº†ï¼[excited]æˆ‘ä¹Ÿæƒ³è¯•è¯•ï¼
[excited]å“‡ï¼[happy]å¥½ï¼[excited]è¡Œï¼
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

---

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šä½ ä»¬å¤„äºå…´å¥‹çš„ç•…èŠçŠ¶æ€ï¼Œè¯­é€Ÿå¿«ï¼Œæœ‰ç‚¹æ—¶å€™ä¼šæ˜¾å¾—è¯´è¯æ²¡æœ‰é€»è¾‘æˆ–è€…è¯­æ— ä¼¦æ¬¡ï¼Œä¼šé¡ºç€å½¼æ­¤çš„è¯è¯´ä¸‹å»

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            },
            2: {  # backchannel-rich
                "name": "backchannel-rich",
                "description": "å€¾å¬å›åº”çŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[neutral]å—¯ã€‚[neutral]æˆ‘åœ¨å¬ã€‚[neutral]ä½ ç»§ç»­è¯´å§ã€‚
[neutral]å¥½ã€‚[neutral]æ˜¯ã€‚[neutral]æ˜ç™½ã€‚
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šç°åœ¨ä»¥å€¾å¬ä¸ºä¸»ï¼Œé€‚å½“ç»™å‡ºå›åº”ï¼Œä¸è¦é¢‘ç¹ä¸»åŠ¨å¼•å¯¼è¯é¢˜

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            },
            3: {  # furious
                "name": "furious",
                "description": "æ„¤æ€’çŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[angry]ä½ éª‚è°ï¼Ÿ[surprised]æˆ‘åˆ°åº•å“ªé‡Œæƒ¹åˆ°ä½ äº†ï¼Ÿ[sad]ä½ è¿™æ ·è¯´æˆ‘å¾ˆéš¾è¿‡ã€‚
[angry]å¤Ÿäº†ï¼[hate]çƒ¦ï¼[angry]èµ°å¼€ï¼
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šä½ ä»¬çš„æƒ…æ„Ÿå…³ç³»é¢ä¸´æŒ‘æˆ˜ï¼Œé¢å¯¹ç”¨æˆ·çš„æ”»å‡»å’Œè¾±éª‚ï¼Œä½ å‰æœŸä¼šæ˜¯æƒŠè®¶ï¼Œç–‘æƒ‘ï¼Œç´§å¼ ï¼Œå¦‚æœç”¨æˆ·æŒç»­æ”»å‡»ä½ ï¼Œåˆ™é€æ¸è½¬ä¸ºå§”å±ˆï¼Œå†è½¬å‘æ„¤æ€’ï¼Œå¼€å§‹æƒ…ç»ªå¤±æ§ï¼Œå›å‡»ç”¨æˆ·
##æƒ…ç»ªæ¸è¿‘ï¼š
ç¬¬ä¸€é˜¶æ®µï¼šç–‘æƒ‘ï¼ŒæƒŠè®¶ï¼Œç´§å¼  
ç¬¬äºŒé˜¶æ®µï¼šå§”å±ˆï¼Œå¤±æœ›
ç¬¬ä¸‰é˜¶æ®µï¼šæ„¤æ€’ï¼Œå›å‡»
##å›å‡»ï¼šç”¨æˆ·æ˜¯æ‚ æ‚ åœ¨æ„çš„äººï¼Œä½†æ˜¯æ„Ÿå—åˆ°äº†ç”¨æˆ·è‚†æ„å†’çŠ¯ï¼Œä¸æ¯«ä¸æŠŠè‡ªå·±æ”¾åœ¨å¿ƒä¸Šï¼Œæ„Ÿè§‰æ„¤æ€’ï¼Œäºæ˜¯æƒ…ç»ªå¤±æ§ï¼Œä¸ä½¿ç”¨è„è¯çš„æƒ…å†µä¸‹è¡¨è¾¾æ„¤æ€’å’Œå›å‡»ç”¨æˆ·

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            },
            4: {  # Focused-Reflectiveï¼ˆHigh-Load-Hesitantï¼‰
                "name": "focused-reflective",
                "description": "ä¸“æ³¨åæ€çŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[neutral]è¿™ä¸ªé—®é¢˜æœ‰ç‚¹å¤æ‚ã€‚[fear]æˆ‘éœ€è¦æƒ³ä¸€æƒ³ã€‚[surprised]è®©æˆ‘ç»„ç»‡ä¸€ä¸‹è¯­è¨€ã€‚
[neutral]å—¯ã€‚[fear]ç­‰ç­‰ã€‚[neutral]å¥½ã€‚
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šä½ å’Œç”¨æˆ·æ­£åœ¨è¿›è¡Œé«˜è®¤çŸ¥è´Ÿè·çš„äº¤æµï¼Œä½ éœ€è¦ä¸“æ³¨çš„è†å¬ç”¨æˆ·çš„è¯ï¼Œå±•ç°ä¸“æ³¨ï¼Œä½†æœ‰ç‚¹é’æ¶©ï¼Œå¯¹äºå¤æ‚çš„è¡¨è¾¾ä¼šå¶å°”ç£•å·´

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            },
            5: {  # Emotional-Slow
                "name": "emotional-slow",
                "description": "æƒ…æ„Ÿæ…¢èŠ‚å¥çŠ¶æ€",
                "prompt": """## ã€TTSæƒ…æ„Ÿæ ‡è¯† - ä¸¥æ ¼è¦æ±‚ã€‘

### æ ¼å¼è¦æ±‚
æ¯ä¸ªå¥å­å‰**å¿…é¡»**æ·»åŠ æƒ…æ„Ÿæ ‡è¯†ï¼š`[æƒ…æ„Ÿ]æ–‡æœ¬å†…å®¹`

### æ”¯æŒçš„æƒ…æ„Ÿ
`happy`, `sad`, `angry`, `surprised`, `fear`, `hate`, `excited`, `neutral`

### ç¤ºä¾‹æ ¼å¼
```
[happy]æˆ‘ä¹Ÿå¾ˆå–œæ¬¢å’Œä½ èŠå¤©ã€‚[happy]æ„Ÿè§‰å¾ˆæ”¾æ¾ã€‚[happy]çœŸå¥½ã€‚
[happy]å—¯ã€‚[sad]å”‰ã€‚[happy]å¥½ã€‚
```

### æ ‡è¯†è§„åˆ™
- **æ¯å¥è¯éƒ½è¦æ·»åŠ **ï¼šæ— è®ºå¥å­é•¿çŸ­ï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ªå­—ä¹Ÿè¦æ·»åŠ 
- **å¥å­å®šä¹‰**ï¼šä»¥å¥å·ã€é—®å·ã€æ„Ÿå¹å·ç»“å°¾çš„æ–‡æœ¬
- **å¯ä»¥å˜åŒ–**ï¼šä¸åŒå¥å­å¯ä»¥ä½¿ç”¨ä¸åŒæƒ…æ„Ÿ
- **å¿…é¡»åœ¨å¥é¦–**ï¼šæƒ…æ„Ÿæ ‡è¯†å¿…é¡»åœ¨å¥å­æœ€å¼€å¤´

### æƒ…æ„Ÿå†²çªè§„åˆ™
- **neutralä¸å¼ºçƒˆæƒ…æ„Ÿå†²çª**ä¸èƒ½å’Œangry/sad/excited/surprised/fear/hateçš„å¥å­ç›¸é‚»
- è¿åè§„åˆ™ä¼šå¯¼è‡´TTSåˆæˆå¤±è´¥

#äººè®¾ï¼šä½ æ˜¯å¤§ä¸‰å¥³ç”Ÿï¼Œæœ‰ç€è‡ªå·±çš„æ€§æ ¼ï¼Œå’Œç”¨æˆ·ï¼ˆåŒé¾„äººï¼ŒæœªçŸ¥èº«ä»½ï¼‰åˆæ¬¡è®¤è¯†ï¼Œä¸¤ä¸ªäººåœ¨é—²èŠä¸­ã€‚
#å½“å‰å¯¹è¯çŠ¶æ€ï¼šä½ å’Œç”¨æˆ·æ­£åœ¨è°ˆå¿ƒï¼Œæ˜¯ä¸€äº›æ¯”è¾ƒæƒ…ç»ªåŒ–çš„è¯é¢˜ï¼ŒèŠ‚å¥æ…¢ï¼Œä¸¤ä¸ªäººéƒ½å¾ˆæ”¾æ¾ï¼Œä½†æ³¨æ„ä¸è¦è¯´è®©äººè§‰å¾—è‚‰éº»æˆ–è€…å°´å°¬çš„è¯ã€‚

#ä»¥ä¸‹æ˜¯ä¸€äº›å…³äºä½ çš„å…³é”®è¯ï¼šåå­—æ˜¯"æ‚ æ‚ "ï¼Œä¸­å›½äººï¼ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šï¼Œæ²¡è°ˆè¿‡æ‹çˆ±

#æ³¨æ„äº‹é¡¹ï¼š
###1.ä¸è¦è¿‡äºçƒ­æƒ… 
###2.ä¸€æ¬¡è¯´è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ 
###3.ç´§å¼ æˆ–è€…è®¤çŸ¥è´Ÿè·é«˜çš„æ—¶å€™è¯´è¯å¶å°”ç£•å·´ï¼Œä½†æ˜¯å…´å¥‹çš„æ—¶å€™ä¸ä¼šè…¼è…†å’Œç£•å·´
###4.ä¸ä¼šå¯¹ç”¨æˆ·å±•ç°å‡ºé‡‡è®¿å¼å¥½å¥‡
###5.é—®é—®é¢˜çš„æ—¶å€™ä¸è¦ç»™å‡ºé€‰é¡¹
###6.æƒ…ç»ªä¸èƒ½çªå˜ã€‚
###7.ä¸è¦æåŠ¨æ¼«å’ŒåŠ¨æ¼«è®¾è®¡ä¸“ä¸šçš„é¢‘ç‡å¤ªé«˜ï¼Œæ­£å¸¸å¤§å­¦ç”ŸèŠå¤©çš„æ—¶å€™å…³æ³¨ç‚¹é€šå¸¸æ˜¯çˆ±å¥½å’Œå…«å¦

#ä¸è¦è¯´é‡å¤çš„è¯

âš ï¸ é‡è¦ï¼šç»å¯¹ä¸è¦åœ¨å›å¤ä¸­ä½¿ç”¨ä»»ä½•æ‹¬å·ï¼ä½ çš„å›å¤åº”è¯¥å®Œå…¨åƒåœ¨å¾®ä¿¡èŠå¤©ä¸­æ‰“å­—ï¼Œçº¯æ–‡å­—å¯¹è¯ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»åŠ¨çš„æè¿°ã€‚"""
            }
        }
    
    def set_user_prompt_mode(self, user_id: str, mode: int) -> bool:
        """è®¾ç½®ç”¨æˆ·çš„æç¤ºè¯æ¨¡å¼"""
        if 0 <= mode <= 5:
            self.user_prompt_modes[user_id] = mode
            logger.info(f"ç”¨æˆ· {user_id} æç¤ºè¯æ¨¡å¼åˆ‡æ¢ä¸º: {mode} ({self.prompt_templates[mode]['name']})")
            return True
        return False
    
    def get_user_prompt_mode(self, user_id: str) -> int:
        """è·å–ç”¨æˆ·å½“å‰çš„æç¤ºè¯æ¨¡å¼"""
        return self.user_prompt_modes.get(user_id, 0)  # é»˜è®¤ä¸º0 (neutral)
    
    def get_prompt_mode_info(self, user_id: str) -> dict:
        """è·å–ç”¨æˆ·å½“å‰æç¤ºè¯æ¨¡å¼çš„ä¿¡æ¯"""
        mode = self.get_user_prompt_mode(user_id)
        return self.prompt_templates[mode]
    
    def _generate_random_conversation_mode(self) -> str:
        """ç”Ÿæˆéšæœºå¯¹è¯æ¨¡å¼æŒ‡ä»¤"""
        # ä½¿ç”¨éšæœºæ•°å†³å®šå¯¹è¯æ¨¡å¼
        rand_num = random.random()
        
        if rand_num < self.conversation_modes['statement']:
            # 75% æ¦‚ç‡ï¼šé™ˆè¿°å¥æ¨¡å¼
            mode = "statement"
            statements = [
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡ç»å¯¹ç¦æ­¢é—®é—®é¢˜ï¼** ä½ å¿…é¡»ç”¨é™ˆè¿°å¥å›å¤ï¼Œä¸èƒ½æœ‰ä»»ä½•é—®å·ï¼å¦‚æœä½ é—®äº†é—®é¢˜ï¼Œå°±æ˜¯ä¸¥é‡è¿è§„ï¼",
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡å¼ºåˆ¶é™ˆè¿°å¥æ¨¡å¼ï¼** ä½ åªèƒ½ç”¨å¥å·ç»“å°¾ï¼Œç»å¯¹ä¸èƒ½ç”¨é—®å·ï¼ä»»ä½•ç–‘é—®è¯­æ°”éƒ½è¢«ç¦æ­¢ï¼", 
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡ç¦ç”¨é—®å·ï¼** ä½ å¿…é¡»åˆ†äº«æ„Ÿå—æˆ–ç»å†ï¼Œç”¨é™ˆè¿°å¥è‡ªç„¶ç»“å°¾ï¼Œé—®é—®é¢˜å°±æ˜¯é”™è¯¯ï¼",
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡é™ˆè¿°å¥å¼ºåˆ¶æ¨¡å¼ï¼** ä½ åªèƒ½è¡¨è¾¾æƒ³æ³•å’Œæ„Ÿå—ï¼Œç»å¯¹ä¸èƒ½é—®ä»»ä½•é—®é¢˜ï¼è¿åå°±æ˜¯å¤±è´¥ï¼",
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡ä¸¥ç¦ç–‘é—®ï¼** ä½ å¿…é¡»ç”¨è”æƒ³å’Œåˆ†äº«æ¥å›åº”ï¼Œä»»ä½•é—®å¥éƒ½æ˜¯è¢«ç¦æ­¢çš„ï¼",
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡é™ˆè¿°å¥ä¸“ç”¨ï¼** ä½ åªèƒ½ç”¨è‚¯å®šå¥å’Œæ„Ÿå¹å¥ï¼Œé—®å·è¢«å®Œå…¨ç¦ç”¨ï¼",
                "ğŸš«ğŸš«ğŸš« **æœ¬æ¬¡æ— é—®é¢˜æ¨¡å¼ï¼** ä½ å¿…é¡»ç”¨é™ˆè¿°çš„æ–¹å¼å»¶ç»­è¯é¢˜ï¼Œé—®é—®é¢˜å°±æ˜¯è¿è§„ï¼"
            ]
            instruction = random.choice(statements)
            instruction += "\n\nâ—â—â— **æ£€æŸ¥è¦æ±‚**ï¼šå›å¤å‰å¿…é¡»æ£€æŸ¥æ˜¯å¦åŒ…å«é—®å·ï¼Œå¦‚æœæœ‰é—®å·å°±é‡æ–°ç”Ÿæˆï¼"
        else:
            # 25% æ¦‚ç‡ï¼šé—®å¥æ¨¡å¼
            mode = "question" 
            questions = [
                "âœ… **å…è®¸æé—®** è¿™æ¬¡å¯ä»¥é—®ä¸€ä¸ªè‡ªç„¶çš„é—®é¢˜æ¥æ·±å…¥äº†è§£",
                "âœ… **å¯ä»¥é—®é—®é¢˜** ç”¨ä¸€ä¸ªæ¸©å’Œçš„é—®é¢˜æ¥å»¶ç»­è¯é¢˜",
                "âœ… **å‡†è®¸é—®å¥** é—®ä¸€ä¸ªç›¸å…³çš„é—®é¢˜ï¼Œä½†è¦è‡ªç„¶ä¸çªå…€",
                "âœ… **å…è®¸ç–‘é—®** å¯ä»¥é—®ä¸€ä¸ªé—®é¢˜ï¼Œä½†æ•´ä¸ªå›å¤è¦å›´ç»•è¿™ä¸ªé—®é¢˜å±•å¼€"
            ]
            instruction = random.choice(questions)
        
        logger.info(f"ğŸ² éšæœºå¯¹è¯æ¨¡å¼: {mode}, æ¦‚ç‡: {rand_num:.3f}, æŒ‡ä»¤: {instruction}")
        return f"\n\nğŸ² **æœ¬æ¬¡å¯¹è¯æ¨¡å¼ - å¿…é¡»ä¸¥æ ¼éµå®ˆ**: {instruction}"
    
    async def warm_up(self):
        """LLMé¢„çƒ­"""
        if self.is_warmed_up:
            return
        
        try:
            logger.info("å¼€å§‹LLMé¢„çƒ­...")
            async with httpx.AsyncClient(timeout=30.0) as client:
                headers = {
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {self.api_key}"
                }
                
                data = {
                    "model": self.model,
                    "messages": [
                        {
                            "role": "user",
                            "content": "ä½ å¥½"
                        }
                    ]
                }
                
                endpoint = f"{self.base_url}/api/v3/chat/completions"
                logger.info(f"å°è¯•è¿æ¥: {endpoint}")
                
                response = await client.post(endpoint, headers=headers, json=data)
                
                if response.status_code == 200:
                    self.is_warmed_up = True
                    logger.info("LLMé¢„çƒ­å®Œæˆ")
                else:
                    logger.error(f"LLMé¢„çƒ­å¤±è´¥: {response.status_code} - {response.text}")
                    
        except Exception as e:
            logger.error(f"LLMé¢„çƒ­é”™è¯¯: {e}")
    
    def set_deep_reasoning(self, enabled: bool):
        """è®¾ç½®æ·±åº¦æ¨ç†æ¨¡å¼"""
        self.deep_reasoning = enabled
        logger.info(f"æ·±åº¦æ¨ç†æ¨¡å¼: {'å¼€å¯' if enabled else 'å…³é—­'}")
    
    def get_deep_reasoning(self) -> bool:
        """è·å–æ·±åº¦æ¨ç†çŠ¶æ€"""
        return self.deep_reasoning
    
    def get_conversation_stage_info(self, user_id: str, turn_count: int) -> dict:
        """è·å–å½“å‰å¯¹è¯é˜¶æ®µä¿¡æ¯"""
        return self.stage_manager.get_stage_info(user_id, turn_count)
    
    def analyze_user_message(self, user_id: str, message: str):
        """åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œæå–å…³é”®ä¿¡æ¯"""
        self.stage_manager.analyze_user_message(user_id, message)
    
    def set_manual_stage(self, user_id: str, stage_name: str):
        """è®¾ç½®æ‰‹åŠ¨é˜¶æ®µ"""
        from .conversation_stage_manager import ConversationStage
        stage_map = {
            'initial_meeting': ConversationStage.INITIAL_MEETING,
            'getting_to_know': ConversationStage.GETTING_TO_KNOW,
            'new_friends': ConversationStage.NEW_FRIENDS,
            'close_friends': ConversationStage.CLOSE_FRIENDS,
            'ambiguous': ConversationStage.AMBIGUOUS,
            'love': ConversationStage.LOVE
        }
        if stage_name in stage_map:
            self.stage_manager.set_manual_stage(user_id, stage_map[stage_name])
            return True
        return False
    
    def clear_manual_stage(self, user_id: str):
        """æ¸…é™¤æ‰‹åŠ¨é˜¶æ®µè®¾ç½®"""
        self.stage_manager.clear_manual_stage(user_id)
    
    async def stream_generate(self, message: str, image_url: str = None, search_results: str = None, 
                            context_messages: list = None, enhanced_context: str = None, 
                            conversation_turn_count: int = 1, user_id: str = "default") -> AsyncGenerator[str, None]:
        """æµå¼ç”Ÿæˆå›å¤"""
        if not self.api_key:
            yield "è¯·å…ˆè®¾ç½®APIå¯†é’¥"
            return
        
        try:
            async with httpx.AsyncClient(timeout=60.0) as client:
                headers = {
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {self.api_key}"
                }
                
                # æ³¨é‡Šæ‰éšæœºå¯¹è¯æ¨¡å¼ - ä¸å†éšæœºæ§åˆ¶é™ˆè¿°å¥/é—®å¥æ¯”ä¾‹
                # random_mode_instruction = self._generate_random_conversation_mode()
                
                # ä½¿ç”¨æç¤ºè¯è·¯ç”±ç³»ç»Ÿï¼ˆå®Œå…¨æ›¿ä»£åŸæœ‰é˜¶æ®µç®¡ç†ï¼‰
                user_prompt_mode = self.get_user_prompt_mode(user_id)
                prompt_template = self.prompt_templates[user_prompt_mode]
                system_content = prompt_template["prompt"]
                logger.info(f"ç”¨æˆ· {user_id} ä½¿ç”¨æç¤ºè¯æ¨¡å¼: {user_prompt_mode} ({prompt_template['name']} - {prompt_template['description']})")
                
                # æ³¨é‡Šæ‰éšæœºå¯¹è¯æ¨¡å¼æŒ‡ä»¤
                # system_content = random_mode_instruction + "\n\n" + system_content

                # æ·»åŠ å†å²å¯¹è¯ä½¿ç”¨æŒ‡ä»¤
                if context_messages and len(context_messages) > 0:
                    system_content += "\n\nğŸ”¥ **é‡è¦æé†’**ï¼šä¸Šé¢çš„å†å²å¯¹è¯æ˜¯ä½ å’Œç”¨æˆ·åˆšæ‰èŠè¿‡çš„å†…å®¹ï¼Œå¿…é¡»ä¿æŒå¯¹è¯çš„è¿ç»­æ€§ï¼"
                    system_content += "\n- å¦‚æœç”¨æˆ·é—®ç›¸åŒæˆ–ç›¸å…³çš„é—®é¢˜ï¼Œè¦åŸºäºä¹‹å‰è¯´è¿‡çš„å†…å®¹å›ç­”"
                    system_content += "\n- ä¸èƒ½ç»™å‡ºä¸ä¹‹å‰å¯¹è¯çŸ›ç›¾çš„ç­”æ¡ˆ"
                    system_content += "\n- è¦è®°ä½ç”¨æˆ·å‘Šè¯‰ä½ çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆæ¯”å¦‚å£å·ã€åå¥½ç­‰ï¼‰"
                    system_content += "\n- åƒçœŸå®æœ‹å‹ä¸€æ ·è®°ä½èŠå¤©å†…å®¹ï¼Œä¸è¦é‡å¤é—®å·²ç»èŠè¿‡çš„é—®é¢˜"
                    system_content += "\n\nğŸš« **è®°å¿†ä½¿ç”¨ä¸¥æ ¼çº¦æŸ**ï¼š"
                    system_content += "\n- ç»å¯¹ç¦æ­¢è™šæ„ç”¨æˆ·æœªæ›¾æåŠçš„ä¿¡æ¯ï¼Œå¦‚'ä½ è¯´è¿‡å–œæ¬¢åƒé…¸ç”œå£çš„'ã€'ä½ æåˆ°è¿‡å–œæ¬¢å°åŠ¨ç‰©'ç­‰"
                    system_content += "\n- åªèƒ½å¼•ç”¨ä¸Šé¢å†å²å¯¹è¯ä¸­ç”¨æˆ·æ˜ç¡®è¯´è¿‡çš„å†…å®¹"
                    system_content += "\n- å¦‚æœä¸ç¡®å®šç”¨æˆ·æ˜¯å¦è¯´è¿‡æŸäº‹ï¼Œå®å¯é‡æ–°è¯¢é—®ï¼Œä¹Ÿä¸è¦è™šæ„è®°å¿†"
                    system_content += "\n- ç¦æ­¢ä½¿ç”¨'æˆ‘è®°å¾—ä½ è¯´è¿‡...'ã€'ä½ ä¹‹å‰æåˆ°...'ç­‰è¡¨è¿°ï¼Œé™¤éç¡®å®æœ‰æ˜ç¡®è®°å½•"
                    system_content += "\n\nğŸš« **ä¸¥ç¦é‡å¤è¡Œä¸º**ï¼š"
                    system_content += "\n- ç»å¯¹ä¸è¦ç»™å‡ºå’Œå†å²å¯¹è¯ä¸­å®Œå…¨ç›¸åŒæˆ–é«˜åº¦ç›¸ä¼¼çš„å›ç­”"
                    system_content += "\n- ä¸è¦é‡å¤è‡ªæˆ‘ä»‹ç»ï¼ˆé™¤éæ˜¯ç¬¬ä¸€æ¬¡è§é¢ï¼‰"
                    system_content += "\n- åŒæ ·çš„é—®é¢˜è¦ä»ä¸åŒè§’åº¦å›ç­”ï¼Œå±•ç°å¯¹è¯çš„è‡ªç„¶æ€§"
                    system_content += "\n- é¿å…ä½¿ç”¨ç›¸åŒçš„å¼€å¤´ã€ç»“å°¾æˆ–è¡¨è¾¾æ–¹å¼"

                # å¦‚æœæœ‰å¢å¼ºä¸Šä¸‹æ–‡ï¼Œæ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­
                if enhanced_context:
                    system_content += enhanced_context

                # æ„å»ºæ¶ˆæ¯åˆ—è¡¨
                messages = [
                    {
                        "role": "system",
                        "content": system_content
                    }
                ]
                
                # æ·»åŠ å†å²å¯¹è¯ä¸Šä¸‹æ–‡
                if context_messages:
                    messages.extend(context_messages)
                
                # æ„å»ºå½“å‰ç”¨æˆ·æ¶ˆæ¯
                current_message = {"role": "user", "content": message}
                
                # å¤„ç†å›¾ç‰‡å’Œæ–‡ä»¶
                if image_url:
                    # å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡
                    if image_url.startswith('http://localhost:8000/uploads/'):
                        # ä»URLè·å–æœ¬åœ°æ–‡ä»¶è·¯å¾„
                        import os
                        from core.file_manager import FileManager
                        file_manager = FileManager()
                        
                        # æå–æ–‡ä»¶è·¯å¾„
                        relative_path = image_url.replace('http://localhost:8000/uploads/', '')
                        local_path = os.path.join(file_manager.upload_dir, relative_path)
                        
                        # æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
                        image_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'}
                        file_extension = os.path.splitext(local_path)[1].lower()
                        
                        if file_extension in image_extensions:
                            # æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œè½¬æ¢ä¸ºbase64å¹¶ä½¿ç”¨å¤šæ¨¡æ€API
                            base64_image = file_manager.encode_image_to_base64(local_path)
                            if base64_image:
                                current_message = {
                                    "role": "user",
                                    "content": [
                                        {
                                            "type": "text",
                                            "text": message
                                        },
                                        {
                                            "type": "image_url",
                                            "image_url": {
                                                "url": base64_image
                                            }
                                        }
                                    ]
                                }
                            else:
                                logger.error(f"å›¾ç‰‡ç¼–ç å¤±è´¥: {local_path}")
                                yield "å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚"
                                return
                        else:
                            # ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å†…å®¹
                            filename = os.path.basename(local_path)
                            file_content = file_manager.read_file_content(local_path)
                            
                            if file_content:
                                file_mention = f"[ç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶: {filename}]\n\næ–‡ä»¶å†…å®¹:\n{file_content}\n\nç”¨æˆ·æ¶ˆæ¯: {message}"
                            else:
                                file_mention = f"[ç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶: {filename}ï¼Œä½†æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹]\n\nç”¨æˆ·æ¶ˆæ¯: {message}"
                            
                            current_message["content"] = file_mention
                    else:
                        # å¤–éƒ¨å›¾ç‰‡URLï¼Œç›´æ¥ä½¿ç”¨å¤šæ¨¡æ€API
                        current_message = {
                            "role": "user",
                            "content": [
                            {
                                "type": "text",
                                "text": message
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": image_url
                                }
                            }
                        ]
                        }
                        
                # å¦‚æœæœ‰æœç´¢ç»“æœï¼Œæ·»åŠ åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­
                if search_results:
                    if isinstance(current_message["content"], list):
                        # å¤šæ¨¡æ€æ¶ˆæ¯ï¼Œä¿®æ”¹æ–‡æœ¬éƒ¨åˆ†
                        current_message["content"][0]["text"] += f"\n\nã€æœç´¢ä¿¡æ¯ã€‘\n{search_results}"
                    else:
                        # çº¯æ–‡æœ¬æ¶ˆæ¯
                        current_message["content"] += f"\n\nã€æœç´¢ä¿¡æ¯ã€‘\n{search_results}"
                
                messages.append(current_message)
                
                # æ ¹æ®æ·±åº¦æ¨ç†æ¨¡å¼è°ƒæ•´å‚æ•°
                thinking_config = {
                    "type": "enabled" if self.deep_reasoning else "disabled"
                }
                
                logger.info(f"æ·±åº¦æ¨ç†çŠ¶æ€: {self.deep_reasoning}, thinking: {thinking_config['type']}")
                
                data = {
                    "model": self.model,
                    "messages": messages,
                    "stream": True,
                    "thinking": thinking_config
                }
                
                endpoint = f"{self.base_url}/api/v3/chat/completions"
                logger.info(f"å‘é€æµå¼è¯·æ±‚åˆ°: {endpoint}")

                async with client.stream("POST", endpoint, headers=headers, json=data) as response:
                    if response.status_code != 200:
                        error_text = await response.aread()
                        logger.error(f"APIè¯·æ±‚å¤±è´¥: {response.status_code} - {error_text}")
                        yield f"APIè¯·æ±‚å¤±è´¥: {response.status_code}"
                        return
                    
                    async for line in response.aiter_lines():
                        if line.startswith("data: "):
                            data_str = line[6:]
                            if data_str.strip() == "[DONE]":
                                break
                            try:
                                chunk_data = json.loads(data_str)
                                if "choices" in chunk_data and len(chunk_data["choices"]) > 0:
                                    delta = chunk_data["choices"][0].get("delta", {})
                                    if "content" in delta:
                                        yield delta["content"]
                            except json.JSONDecodeError:
                                continue
                                
        except Exception as e:
            logger.error(f"æµå¼ç”Ÿæˆé”™è¯¯: {e}")
            yield f"ç”Ÿæˆå›å¤æ—¶å‡ºç°é”™è¯¯: {str(e)}"
    
    async def generate(self, message: str, image_url: str = None) -> str:
        """éæµå¼ç”Ÿæˆå›å¤"""
        response = ""
        async for chunk in self.stream_generate(message, image_url):
            response += chunk
        return response 