# 链接预览功能 - 使用说明

## ✅ 已完成

AI 回答中的链接现在会**自动转换为可点击**，并在消息底部显示**链接预览卡片**。

---

## 📦 两种链接卡片模式

### 1️⃣ **简化版卡片**（推荐，默认启用）

- ✅ **更快**：不依赖外部截图服务
- ✅ **更稳定**：加载速度快，不会失败
- ✅ **更简洁**：显示网站 favicon + 域名 + 完整URL

**外观**：
```
[网站图标] example.com
           https://example.com/path
```

### 2️⃣ **带截图版卡片**（可选）

- 🖼️ 显示网页实时截图
- ⚠️ 依赖第三方服务（thum.io）
- ⚠️ 可能较慢或加载失败（受网络影响）

**外观**：
```
┌─────────────────┐
│  [网页截图]      │
├─────────────────┤
│ example.com     │
│ https://...     │
└─────────────────┘
```

---

## 🔧 切换模式

### 方法1：全局切换（修改默认值）

编辑 `components/Linkify.tsx`：

```typescript
// 使用简化版（默认，推荐）
export default function Linkify({ text, withCards = true, size = 'sm', useSimpleCard = true }: Props)

// 使用带截图版
export default function Linkify({ text, withCards = true, size = 'sm', useSimpleCard = false }: Props)
```

### 方法2：单独指定

在使用 `Linkify` 组件时传递参数：

```tsx
{/* 使用简化版 */}
<Linkify text={msg.content} withCards size="sm" useSimpleCard={true} />

{/* 使用带截图版 */}
<Linkify text={msg.content} withCards size="sm" useSimpleCard={false} />
```

---

## 🧪 测试截图服务

打开浏览器访问：
```
file:///Users/juntinghua/Desktop/agent/test-link-preview.html
```

这个测试页面会告诉你截图服务是否正常工作。

---

## 🎨 效果预览

### 当 AI 回答包含链接时：

```markdown
2024-2025年AI行业趋势分析...

**【参考资料】**
- https://hai.stanford.edu/ai-index/2025-ai-index-report
- https://www.pwc.com/us/en/tech-effect/ai-analytics/ai-predictions.html
```

会自动渲染为：

1. ✅ 文本中的链接变成**蓝色可点击**
2. ✅ 消息底部显示**链接预览卡片**（2个）
3. ✅ 点击任意位置打开原网页

---

## ⚙️ 配置截图服务（可选）

### 使用 Microlink 服务

1. 注册 [Microlink](https://microlink.io/)
2. 获取 API Key
3. 在 `.env.local` 添加：
   ```bash
   NEXT_PUBLIC_LINK_SCREENSHOT_PROVIDER=microlink
   ```

### 自建截图服务（推荐生产环境）

可以使用以下开源项目：
- [Puppeteer](https://github.com/puppeteer/puppeteer)
- [Playwright](https://github.com/microsoft/playwright)
- [screenshot-api](https://github.com/screenshotone/screenshotone-api-sdk)

---

## 🐛 故障排查

### 问题1：看不到任何链接卡片

**解决方案**：
- 检查浏览器控制台（F12）是否有报错
- 确认 AI 回答中确实包含了 `https://` 链接
- 检查 `Linkify` 组件的 `withCards` 参数是否为 `true`

### 问题2：简化版卡片图标不显示

**解决方案**：
- 这是正常的，有些网站没有 favicon
- 会自动显示默认的地球图标 🌐

### 问题3：截图版卡片显示"预览不可用"

**原因**：
- 截图服务被墙或网络问题
- 目标网站拒绝被截图
- 服务速率限制

**解决方案**：
- 切换到简化版卡片（推荐）
- 使用 VPN/代理访问
- 自建截图服务

---

## 📝 相关文件

- `components/Linkify.tsx` - 主组件
- `components/LinkCard.tsx` - 带截图版卡片
- `components/LinkCardSimple.tsx` - 简化版卡片
- `components/extractUrls.ts` - URL 提取工具
- `app/chat/page.tsx` - 聊天页面（已集成）
- `test-link-preview.html` - 测试页面

---

## 🎯 推荐配置

**生产环境**：
```tsx
<Linkify text={msg.content} withCards size="sm" useSimpleCard={true} />
```

**开发/测试**：
```tsx
<Linkify text={msg.content} withCards size="sm" useSimpleCard={false} />
```

**性能优先**：
```tsx
<Linkify text={msg.content} withCards={false} />  // 只转换链接，不显示卡片
```

---

## 🚀 下一步优化建议

1. ✅ 已完成：链接自动识别
2. ✅ 已完成：简化版卡片
3. ✅ 已完成：带截图版卡片
4. 🔜 待实现：链接卡片缓存（避免重复加载）
5. 🔜 待实现：自定义卡片样式
6. 🔜 待实现：链接元数据抓取（标题、描述）

---

## 📊 当前状态

- ✅ 链接自动识别：**已启用**
- ✅ 链接可点击：**已启用**
- ✅ 简化版卡片：**已启用（默认）**
- ✅ 带截图版卡片：**可选**
- ✅ 在 `page.tsx` 中已集成
- ✅ 在 `app/api/chat/route.ts` 提示词中已添加"附上参考资料"要求

---

**如有问题，请查看浏览器控制台日志或联系开发者！** 🎉

