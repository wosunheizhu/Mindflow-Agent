# 下载链接修复说明

## 问题描述

之前 Agent 生成的文件下载链接显示为 `sandbox:/api/download?token=xxx`，无法在浏览器中直接打开。

## 问题原因

工具返回的是**相对路径** `/api/download?token=xxx`，这在某些环境（如 Claude、OpenAI 等）中会被显示为 `sandbox:` 协议，导致浏览器无法识别。

## 解决方案

### 已修复的工具

1. **文档创建工具** (`create_document`)
   - Word (.docx)
   - Excel (.xlsx)
   - PowerPoint (.pptx)
   - PDF (.pdf)
   - Markdown (.md)

2. **图表生成工具** (`create_chart`)
   - 柱状图 (bar)
   - 折线图 (line)
   - 饼图 (pie)

### 修复内容

将相对路径转换为完整的可访问 URL：

```typescript
// 修复前
const download_url = `/api/download?token=${token}`;

// 修复后
const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
const download_url = `${baseUrl}/api/download?token=${token}`;
```

### 环境变量配置

在 `.env.local` 中添加（可选）：

```bash
# 本地开发环境（默认）
NEXT_PUBLIC_APP_URL=http://localhost:3000

# 生产环境示例
# NEXT_PUBLIC_APP_URL=https://yourdomain.com
```

如果不设置，默认使用 `http://localhost:3000`。

## 使用示例

### 生成文档

```
用户：帮我创建一个关于 AI 技术的 Word 文档
Agent：调用 create_document 工具
返回：{
  "success": true,
  "filename": "AI技术_xxx.docx",
  "download_url": "http://localhost:3000/api/download?token=xxx",
  "note": "✅ 文档已生成，点击下载: http://localhost:3000/api/download?token=xxx"
}
```

### 生成图表

```
用户：帮我创建一个销售数据的柱状图
Agent：调用 create_chart 工具
返回：{
  "success": true,
  "filename": "bar_chart_xxx.html",
  "download_url": "http://localhost:3000/api/download?token=xxx",
  "note": "✅ 图表已生成，点击下载: http://localhost:3000/api/download?token=xxx"
}
```

## 技术细节

### 下载机制

1. **注册下载** (`registerDownload`)
   - 将文件内容保存到 `.temp-downloads/` 目录
   - 生成唯一 token
   - 保存文件元数据（文件名、MIME类型、创建时间）

2. **下载接口** (`/api/download`)
   - 接收 token 参数
   - 验证 token 有效性和过期时间（30分钟）
   - 返回文件内容
   - 下载后自动删除临时文件（一次性使用）

3. **安全性**
   - Token 随机生成，难以预测
   - 30分钟自动过期
   - 下载后立即删除
   - 跨域保护

### 文件存储位置

```
项目根目录/
└── .temp-downloads/
    ├── {token}.data       # 文件内容
    └── {token}.meta.json  # 元数据
```

## 注意事项

1. **临时性**：下载链接只能使用一次，下载后自动失效
2. **有效期**：链接 30 分钟后自动过期
3. **生产环境**：部署到生产环境时，需要设置 `NEXT_PUBLIC_APP_URL` 为实际域名
4. **浏览器兼容**：现在返回的是完整 URL，所有浏览器都可以直接打开

## 测试

### 本地测试

1. 启动服务：`pnpm dev`
2. 与 Agent 对话：
   ```
   帮我创建一份 AI 技术报告的 Word 文档
   ```
3. 点击返回的下载链接
4. 应该能直接下载文件

### 验证 URL 格式

生成的 URL 应该是：
- ✅ `http://localhost:3000/api/download?token=xxx`
- ❌ `sandbox:/api/download?token=xxx`
- ❌ `/api/download?token=xxx`

## 常见问题

### Q: 为什么不直接返回文件内容？
A: 因为 SSE 流式响应不适合传输大文件。使用 token 机制可以：
- 支持大文件下载
- 避免阻塞 Agent 响应
- 提供更好的用户体验

### Q: 可以永久保存文件吗？
A: 当前设计是临时下载。如需永久保存，可以修改为：
1. 保存到 `outputs/` 目录
2. 返回静态文件路径
3. 不自动删除文件

### Q: 如何支持多次下载？
A: 修改 `consumeDownload` 函数，注释掉清理代码：
```typescript
// 读取后不删除，允许多次下载
// await cleanup(token);
```

## 相关文件

- `/lib/tools-complete.ts` - 工具实现
- `/lib/download-registry.ts` - 下载注册表
- `/app/api/download/route.ts` - 下载接口
- `/.temp-downloads/` - 临时文件目录（自动创建）

