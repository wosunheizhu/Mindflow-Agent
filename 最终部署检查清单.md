# 最终部署检查清单

## 📊 当前进度

### ✅ 已完成（本地）
- [x] 链接分类显示功能
- [x] Word 文档生成（docx.js）
- [x] PDF 降级为 HTML（可打印）
- [x] 数字员工提示词优化
- [x] 数字员工服务已重启
- [x] Railway 配置文件冲突解决
- [x] 代码已推送到 GitHub
- [x] Vercel Blob 依赖已安装

### ⏳ 待完成（云端）
- [ ] Vercel 自动部署完成
- [ ] Railway 语音服务配置
- [ ] Railway GPT-5 服务配置
- [ ] Vercel 环境变量更新
- [ ] Vercel 最终 Redeploy
- [ ] 端到端测试

---

## 🎯 立即操作步骤

### 第一步：等待 Vercel 部署（约 2-3 分钟）

访问 https://vercel.com/dashboard

等待最新部署状态变为 **Ready**

---

### 第二步：配置 Railway 语音服务

1. 访问 https://railway.app/dashboard
2. 选择你的项目
3. 点击**语音服务**（Mindflow-Agent 或类似名称）
4. 点击 **Settings** 标签
5. 找到 **Build** 部分
6. 设置：
   ```
   Builder: Dockerfile
   Dockerfile Path: Dockerfile
   ```
7. 点击 **Deploy** 或 **Redeploy**
8. 等待部署完成（约 2-3 分钟）
9. 进入 **Settings → Networking**
10. 点击 **Generate Domain**（如果还没有）
11. **复制生成的 URL**，例如：
    ```
    https://mindflow-voice-service.up.railway.app
    ```

---

### 第三步：配置 Railway GPT-5 服务

1. 在同一个 Railway 项目中
2. 点击 **GPT-5 服务**
3. 点击 **Settings** 标签
4. 找到 **Build** 部分
5. 设置：
   ```
   Builder: Dockerfile
   Dockerfile Path: Dockerfile.gpt5  ← 注意：不同于语音服务！
   ```
6. 点击 **Deploy** 或 **Redeploy**
7. 等待部署完成
8. 进入 **Settings → Networking**
9. 点击 **Generate Domain**
10. **复制生成的 URL**，例如：
    ```
    https://mindflow-gpt5-service.up.railway.app
    ```

---

### 第四步：更新 Vercel 环境变量

1. 返回 Vercel 控制台：https://vercel.com/dashboard
2. 选择项目：**mindflow-agent**
3. 点击 **Settings** 标签
4. 左侧菜单选择 **Environment Variables**
5. 添加/更新以下变量：

**变量1**：
```
Name: NEXT_PUBLIC_VOICE_SERVER_URL
Value: https://mindflow-voice-service.up.railway.app（从 Railway 复制）
Environments: ☑️ Production ☑️ Preview ☑️ Development
```

**变量2**：
```
Name: NEXT_PUBLIC_GPT5_SERVER_URL
Value: https://mindflow-gpt5-service.up.railway.app（从 Railway 复制）
Environments: ☑️ Production ☑️ Preview ☑️ Development
```

6. 点击 **Save**

---

### 第五步：重新部署 Vercel（应用环境变量）

1. 在 Vercel 项目页面
2. 点击 **Deployments** 标签
3. 点击最新部署右侧的 **...** 菜单
4. 选择 **Redeploy**
5. 确认并等待部署完成（约 1-2 分钟）

---

### 第六步：端到端测试

访问你的 Vercel 网站：
```
https://mindflow-agent-efne28pwd-wosunheizhus-projects.vercel.app
```

**测试清单**：

#### 1. 测试数字员工任务识别
```
输入："我要看看图表"

期望：
✅ 小岚回复包含 {{...}} 提示词
✅ Agent 自动执行
✅ 生成图表文件
✅ 提供下载链接
```

#### 2. 测试 Word 生成
```
输入："生成一份 Word 格式的 AI 技术报告"

期望：
✅ AI 生成 .docx 文件
✅ 下载链接显示为蓝色按钮
✅ 点击下载
✅ 可用 Word 打开
```

#### 3. 测试 PDF/HTML 生成
```
输入："生成一份 PDF 格式的市场分析"

期望：
✅ AI 生成 .html 文件
✅ 下载链接显示为蓝色按钮
✅ 打开 HTML 文件
✅ 点击"打印为 PDF"按钮
✅ 另存为 PDF
```

#### 4. 测试链接分类
```
输入："搜索 AI 技术并生成报告"

期望：
✅ AI 搜索并生成报告
✅ 参考链接显示为灰色卡片
✅ 下载链接显示为蓝色按钮
✅ 两种链接自动分类
```

---

## 🔧 验证命令

### 检查 Railway 服务

```bash
# 语音服务
curl https://你的语音服务URL/health
# 期望：{"status": "ok"}

# GPT-5 服务
curl https://你的GPT5服务URL/
# 期望：FastAPI 响应
```

### 检查环境变量

在浏览器控制台（F12 → Console）：

```javascript
// 检查 Railway URL 是否正确注入
console.log('语音服务:', process.env.NEXT_PUBLIC_VOICE_SERVER_URL);
console.log('GPT-5服务:', process.env.NEXT_PUBLIC_GPT5_SERVER_URL);
```

---

## ⚠️ 常见问题

### Q1：Agent 说要生成但不执行

**原因**：Vercel 可能还在运行旧代码，或数字员工服务未重启

**解决**：
1. 等待 Vercel 最新部署完成
2. 确认数字员工服务已重启
3. 刷新浏览器页面

### Q2：Word/PDF 生成失败

**原因**：Vercel 部署还没完成

**解决**：
1. 确认 Vercel 最新部署状态为 Ready
2. 刷新页面清除缓存
3. 重试

### Q3：没有语音播报

**原因**：Railway 语音服务未连接

**解决**：
1. 确认 Railway 语音服务已部署
2. 确认 Vercel 环境变量已添加
3. 确认 Vercel 已重新部署

---

## 📋 完整环境变量清单

### Vercel
```bash
# AI 服务
OPENAI_API_KEY=sk-proj-xxx
OPENAI_BASE_URL=https://api.openai.com/v1
ANTHROPIC_API_KEY=sk-ant-xxx（可选）

# Vercel Blob
BLOB_READ_WRITE_TOKEN=（自动生成）

# Railway 后端
NEXT_PUBLIC_VOICE_SERVER_URL=https://xxx.up.railway.app
NEXT_PUBLIC_GPT5_SERVER_URL=https://yyy.up.railway.app

# 其他
BRAVE_API_KEY=xxx（可选）
```

### Railway 语音服务
```bash
PORT=8001
ARK_API_KEY=xxx
DOUBAO_API_KEY=xxx
XFYUN_APP_ID=xxx
XFYUN_API_KEY=xxx
XFYUN_API_SECRET=xxx
```

### Railway GPT-5 服务
```bash
PORT=8002
OPENAI_API_KEY=sk-proj-xxx
OPENAI_BASE_URL=https://api.openai.com/v1
```

---

## 🎉 完成标志

所有步骤完成后，你应该能够：

- ✅ 数字员工正确识别任务并发送提示词
- ✅ AI 自动执行任务
- ✅ 生成 Word、HTML、Markdown 等格式文件
- ✅ 下载链接正确分类显示（蓝色/灰色）
- ✅ 参考链接自动附在回答结尾
- ✅ 深度思考功能正常
- ✅ 语音播报功能正常

---

**现在按照步骤操作，完成最后的部署配置吧！** 🚀

所有代码已准备就绪，只需要完成云端配置即可！

