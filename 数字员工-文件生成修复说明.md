# 数字员工 - 文件生成修复说明

## ❌ 问题描述

**现象**：
- 用户要求生成 Markdown/Word/PPT 等文件
- 数字员工转述给 Agent 的提示词中**没有强调要生成可下载文件**
- Agent 只是用 Markdown 格式输出文本内容，而不是调用 `create_document` 工具生成文件
- 用户无法下载文件

**示例**：
```
用户："帮我生成一份AI技术报告"
数字员工提示词：{{搜索AI技术并生成报告，使用Markdown格式}}
Agent：[输出一大段Markdown文本，但没有文件下载链接]
结果：❌ 用户想要文件，但只得到了文本
```

---

## ✅ 解决方案

### 修改内容

在 `llm_tts_stream.py` 的数字员工提示词中，新增了**文件生成专项规则**：

```python
**⚠️ 文件生成专项规则（非常重要）**：

当用户要求生成**文档/报告/文件/PPT/Excel/Word**等可下载内容时：
- ✅ **必须明确要求**：使用 create_document/create_presentation/create_spreadsheet 工具生成**可下载的文件**
- ✅ **必须强调**：提供带有 /api/download/ 的下载链接
- ❌ **禁止**：让AI只用Markdown格式输出文本（用户需要的是文件，不是文本）
```

### 关键词识别

数字员工现在会识别以下关键词，自动要求生成文件：
- "生成报告"
- "写一份XXX"
- "帮我做个文档"
- "制作PPT"
- "创建Excel表格"
- "整理成Word"
- "做个分析文档"
- "出一份方案"

### 新的提示词示例

**示例1：生成报告**
```
用户："帮我搜索AI技术并生成报告"

数字员工提示词：
{{请搜索2024-2025年人工智能技术最新发展，重点关注大语言模型、多模态AI、Agent系统三个方向。
**使用create_document工具生成一份可下载的Markdown报告文件**（约2000字），
包含：技术概述与核心突破、主要应用场景、行业影响分析、未来发展趋势。
引用可靠来源，**最后提供文件下载链接**。}}
```

**示例2：市场分析**
```
用户："帮我写一份市场分析"

数字员工提示词：
{{分析2024-2025年目标市场现状和趋势。
**使用create_document工具生成可下载的Word文档**（约1500字），
包含：市场规模、竞争格局、用户画像、机会点分析。
**提供/api/download/开头的下载链接**。}}
```

**示例3：数据图表**
```
用户："做个数据图表"

数字员工提示词：
{{分析提供的数据并生成可视化图表。
**使用create_spreadsheet工具生成Excel文件**，
包含原始数据表和图表页。
**提供可下载的文件链接**。}}
```

---

## 🔧 应用更改

### 方法1：使用脚本（推荐）

```bash
./重启数字员工服务.sh
```

### 方法2：手动重启

```bash
# 停止现有服务
pkill -f "python.*voice_server.py"

# 等待2秒
sleep 2

# 启动新服务
cd /Users/juntinghua/Desktop/agent
source venv_voice/bin/activate
nohup python voice_server.py > voice_server.log 2>&1 &
```

### 方法3：重启整个系统

如果上述方法不生效，可以重启所有服务：

```bash
./重启服务器-应用PPT修复.sh
```

---

## 🧪 测试验证

### 测试用例1：生成报告
```
输入："帮我生成一份AI行业报告"
期望：
1. 数字员工说"马上处理"或类似话语
2. Agent 调用 create_document 工具
3. 最终提供 /api/download/xxx.md 下载链接
```

### 测试用例2：制作PPT
```
输入："做一个关于产品介绍的PPT"
期望：
1. 数字员工理解需求
2. Agent 调用 create_presentation 工具
3. 最终提供 .pptx 文件下载链接
```

### 测试用例3：Excel表格
```
输入："帮我创建一个数据分析表格"
期望：
1. 数字员工识别需求
2. Agent 调用 create_spreadsheet 工具
3. 最终提供 .xlsx 文件下载链接
```

---

## 📊 修改对比

### 修改前 ❌

```
数字员工提示词：
{{搜索AI技术进展，生成约2000字报告。使用Markdown格式，附上数据来源。}}

Agent行为：
- 搜索网页 ✅
- 输出Markdown文本 ❌（不是文件）
- 没有下载链接 ❌

用户体验：只能复制文本，无法下载文件
```

### 修改后 ✅

```
数字员工提示词：
{{搜索AI技术进展，**使用create_document工具生成可下载的Markdown报告文件**（约2000字）。
引用可靠来源，**最后提供文件下载链接**。}}

Agent行为：
- 搜索网页 ✅
- 调用 create_document 工具 ✅
- 生成 .md 文件 ✅
- 提供下载链接 ✅

用户体验：可以直接下载文件，方便使用
```

---

## 🎯 关键改进点

### 1. 明确工具调用
- ✅ 明确要求使用 `create_document` 等工具
- ✅ 强调生成"可下载的文件"

### 2. 强调下载链接
- ✅ 要求提供 `/api/download/` 开头的链接
- ✅ 确保用户能获取到文件

### 3. 禁止纯文本输出
- ❌ 不能只用 Markdown 格式输出文本
- ✅ 必须生成实际的文件

### 4. 关键词识别
- 自动识别用户的文件生成需求
- 根据需求选择合适的工具

---

## 📝 相关文件

- `llm_tts_stream.py` - 数字员工提示词（已修改）
- `重启数字员工服务.sh` - 重启脚本
- `voice_server.py` - 数字员工服务主程序
- `app/api/tools/*.ts` - 文件创建工具实现

---

## 🚨 注意事项

1. **必须重启服务**：修改提示词后需要重启数字员工服务才能生效
2. **测试验证**：建议先测试几个用例，确保功能正常
3. **日志监控**：查看 `voice_server.log` 确认服务运行正常
4. **兼容性**：修改同时应用于男性和女性两种音色的提示词

---

## 🔍 故障排查

### 问题1：修改后仍然只输出文本

**原因**：
- 服务未重启
- 提示词缓存未清除

**解决方案**：
```bash
# 完全停止服务
pkill -f voice_server.py
sleep 3

# 重新启动
./重启数字员工服务.sh
```

### 问题2：数字员工不响应

**原因**：
- 服务启动失败
- 端口冲突

**解决方案**：
```bash
# 查看日志
tail -50 voice_server.log

# 检查进程
ps aux | grep voice_server

# 检查端口
lsof -i :8001  # 假设使用8001端口
```

### 问题3：Agent仍然不生成文件

**原因**：
- Agent 端的工具配置问题
- 文件创建工具未正常工作

**解决方案**：
1. 检查 `lib/tools.ts` 中的工具定义
2. 测试 `create_document` 工具是否可用
3. 查看 Agent 的日志输出

---

## ✅ 验收标准

修改成功后，应该满足：

- ✅ 用户说"生成报告"，Agent 调用 create_document 工具
- ✅ 用户说"做个PPT"，Agent 调用 create_presentation 工具
- ✅ 用户说"创建表格"，Agent 调用 create_spreadsheet 工具
- ✅ 所有文件生成任务都提供下载链接
- ✅ 数字员工的提示词包含明确的工具调用要求

---

**修改时间**：2025-11-02  
**修改文件**：`llm_tts_stream.py`  
**影响范围**：所有通过数字员工发起的文件生成任务  
**状态**：✅ 已完成，待重启应用

---

**如有问题，请查看 `voice_server.log` 或联系开发者！** 🎉

