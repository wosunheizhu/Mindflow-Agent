<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT-5 å‰ç«¯æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">GPT-5 å‰ç«¯è°ƒç”¨æµ‹è¯•</h1>
        
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">æµ‹è¯•é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">æ¨¡å‹</label>
                    <select id="model" class="w-full px-3 py-2 border rounded">
                        <option value="gpt5-pro">Mindflow-Y-Pro</option>
                        <option value="gpt5-thinking">Mindflow-Y</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">æ¶ˆæ¯</label>
                    <input id="message" type="text" value="æµ‹è¯•" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">æ·±åº¦æ€è€ƒç­‰çº§</label>
                    <select id="level" class="w-full px-3 py-2 border rounded">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <button onclick="testGPT5()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    ğŸš€ æµ‹è¯• GPT-5 è°ƒç”¨
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">æ§åˆ¶å°æ—¥å¿—</h2>
            <div id="console" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto"></div>
        </div>
        
        <div class="bg-white rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">å“åº”å†…å®¹</h2>
            <div id="response" class="bg-gray-50 p-4 rounded whitespace-pre-wrap min-h-32"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            console.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        async function testGPT5() {
            const consoleEl = document.getElementById('console');
            const responseEl = document.getElementById('response');
            consoleEl.innerHTML = '';
            responseEl.innerHTML = '';
            
            const model = document.getElementById('model').value;
            const message = document.getElementById('message').value;
            const level = document.getElementById('level').value;
            
            log(`ğŸš€ å¼€å§‹æµ‹è¯• GPT-5 è°ƒç”¨...`);
            log(`ğŸ“‹ æ¨¡å‹: ${model}`);
            log(`ğŸ“‹ æ·±åº¦æ€è€ƒ: ${level}`);
            log(`ğŸ“‹ æ¶ˆæ¯: ${message}`);
            
            const requestBody = {
                messages: [{ role: 'user', content: message }],
                modelProvider: model,
                deepThinkingEnabled: true,
                deepThinkingLevel: level,
                reasoning: { effort: level },
                avatarEnabled: false,
                browserSearch: false,
                hasFiles: false
            };
            
            log(`ğŸ“¤ å‘é€è¯·æ±‚åˆ° /api/chat`);
            log(`ğŸ“¦ è¯·æ±‚ä½“: ${JSON.stringify(requestBody, null, 2)}`);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                log(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ é”™è¯¯å“åº”: ${errorText}`, 'error');
                    responseEl.innerHTML = `é”™è¯¯ ${response.status}: ${errorText}`;
                    return;
                }
                
                log(`ğŸ“– å¼€å§‹è¯»å–å“åº”æµ...`);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';
                let chunkCount = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        log(`âœ… æµç»“æŸï¼Œå…±æ”¶åˆ° ${chunkCount} ä¸ªæ•°æ®å—`, 'success');
                        break;
                    }
                    
                    chunkCount++;
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    if (chunkCount <= 5) {
                        log(`ğŸ“¦ æ•°æ®å— #${chunkCount}: ${chunk.substring(0, 80)}...`);
                    }
                    
                    // å¤„ç†SSEäº‹ä»¶
                    const events = buffer.split('\n\n');
                    buffer = events.pop() || '';
                    
                    for (const evt of events) {
                        const dataLine = evt.split('\n').find(l => l.startsWith('data: '));
                        if (!dataLine) continue;
                        
                        const data = dataLine.substring(6);
                        if (data === '[DONE]') {
                            log(`ğŸ æ”¶åˆ° [DONE] æ ‡è®°`, 'success');
                            continue;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            log(`ğŸ“¨ æ”¶åˆ°äº‹ä»¶: ${parsed.type}`);
                            
                            if (parsed.type === 'content' && parsed.content) {
                                fullResponse += parsed.content;
                                responseEl.innerHTML = fullResponse;
                            } else if (parsed.type === 'reasoning_complete' && parsed.content) {
                                log(`ğŸ§  æ¨ç†å®Œæˆ: ${parsed.content.substring(0, 100)}...`, 'success');
                            } else if (parsed.type === 'error') {
                                log(`âŒ é”™è¯¯: ${parsed.error}`, 'error');
                                responseEl.innerHTML = `é”™è¯¯: ${parsed.error}`;
                            }
                        } catch (e) {
                            log(`âš ï¸ JSON è§£æå¤±è´¥: ${data.substring(0, 50)}`, 'error');
                        }
                    }
                }
                
                if (fullResponse) {
                    log(`âœ… æµ‹è¯•å®Œæˆï¼æ”¶åˆ°å®Œæ•´å“åº”`, 'success');
                } else {
                    log(`âš ï¸ æœªæ”¶åˆ°å†…å®¹å“åº”`, 'error');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                responseEl.innerHTML = `é”™è¯¯: ${error.message}`;
            }
        }
    </script>
</body>
</html>

