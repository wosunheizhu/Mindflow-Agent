# 数字员工双重总结 - 完整诊断与测试

## ✅ 最新修复内容

### 修复1：防止重复提交（app/chat/page.tsx）
- ✅ 添加 `isSubmittingRef` 防止重复调用
- ✅ 添加 `messagesRef` 解决闭包问题
- ✅ 移除 setState 回调中的副作用

### 修复2：延迟播放机制（app/chat/page.tsx）
- ✅ `handleSubmitFromAvatar` - 添加 `_playAvatarSummaryOnce` 延迟播放
- ✅ `handleSend` - 添加 `_playAvatarSummaryOnce` 延迟播放
- ✅ 只在最终阶段（reasoning_complete 或流结束）才播放

### 修复3：添加详细日志
- ✅ 数字员工组件：`handleAvatarChat`、`dispatchEvent` 处
- ✅ 主页面：`handleAvatarTask` 事件监听处
- ✅ 组件去重：3秒内相同内容过滤

---

## 🧪 完整测试步骤

### 第0步：确保服务已重启

```bash
# 终端1 - 重启 Next.js
cd /Users/juntinghua/Desktop/agent
pkill -f "next dev"
pnpm dev

# 终端2 - 查看日志
tail -f next_dev.log
```

### 第1步：完全清除浏览器缓存

**关键！** 必须清除缓存，否则使用的是旧代码！

```
1. 关闭所有 localhost:3000 标签页
2. 打开新的无痕窗口（Cmd+Shift+N / Ctrl+Shift+N）
3. 访问 http://localhost:3000
4. 按 F12 打开开发者工具
5. 切换到 Console 标签
```

### 第2步：打开数字员工并测试

```
1. 点击右下角数字员工头像展开对话框
2. 输入测试消息："搜索量子计算"
3. 按 Enter 发送
```

### 第3步：观察控制台日志

按时间顺序应该看到：

```javascript
// === 数字员工组件日志 ===
🎯 [数字员工] handleAvatarChat 被调用          // ← 应该只出现1次
📦 [前端SSE] 收到事件: type=text              // 多次（正常）
🤖 [实时] 检测到完整提示词，立即发送           // ← 应该只出现1次
📤 [实时] 即将 dispatchEvent                  // ← 应该只出现1次
✅ [实时] 已发送 avatar_agent_task 事件       // ← 应该只出现1次

// === 主聊天页面日志 ===
📨 [主页面] 收到 avatar_agent_task 事件       // ← 应该只出现1次！
📊 [主页面] isSubmittingRef.current = false   // ← 第一次应该是 false
✅ [主页面] 通过防重复检查                     // ← 应该只出现1次

// === Agentic AI 执行 ===
[后续的 AI 执行日志...]

// === 最终总结 ===
[应该只看到一次总结相关的日志]
```

### 第4步：记录问题日志

如果问题仍存在，请记录：

#### A. 看到几次这些日志？

```
🎯 [数字员工] handleAvatarChat 被调用   → ___ 次
📤 [实时] 即将 dispatchEvent            → ___ 次  
📨 [主页面] 收到 avatar_agent_task 事件  → ___ 次
✅ [主页面] 通过防重复检查               → ___ 次
⚠️ [主页面] 检测到重复提交，忽略         → ___ 次
```

#### B. 数字员工窗口显示

小岚说了几句话？内容分别是什么？

#### C. 闪烁情况

- 主聊天区域是否仍在闪烁？
- 闪烁时是否看到内容在变化（像两个不同的回答在切换）？

---

## 🔍 诊断不同场景

### 场景1：handleAvatarChat 被调用2次
**日志特征**：
```
🎯 [数字员工] handleAvatarChat 被调用
🎯 [数字员工] handleAvatarChat 被调用   ← 重复
```
**原因**：可能是表单重复提交或按钮双击
**解决**：需要在 handleAvatarChat 添加防重复

### 场景2：avatar_agent_task 事件被发送2次
**日志特征**：
```
📤 [实时] 即将 dispatchEvent
📤 [实时] 即将 dispatchEvent   ← 重复（不应该出现！promptSent应该防止）
```
**原因**：promptSent 机制失效
**解决**：需要检查 SSE 流是否被并行处理

### 场景3：主页面收到2次事件
**日志特征**：
```
📨 [主页面] 收到 avatar_agent_task 事件
✅ [主页面] 通过防重复检查
📨 [主页面] 收到 avatar_agent_task 事件   ← 第二次
⚠️ [主页面] 检测到重复提交，忽略         ← 应该被拦截
```
**原因**：两次独立的事件被发送
**状态**：第二次应该被 isSubmittingRef 拦截

---

## 📋 请提供以下信息

1. **完整的控制台日志**（从点击发送到收到总结）
2. **上述 A、B、C 的答案**
3. **后端日志**：
```bash
tail -50 next_dev.log | grep -E "开始第.*轮|LLM-TTS"
```

这样我可以精确定位问题！

