# 前后端连接 - 完整步骤指南

## ✅ 当前状态

- ✅ Vercel 前端已部署
- ✅ Railway 语音服务已部署
- ✅ Railway GPT-5 服务已部署
- ✅ 下载链接识别逻辑已修复

---

## 🔗 连接步骤

### 步骤1：获取 Railway 服务 URL

#### 1.1 获取语音服务地址

1. 打开 Railway 控制台：https://railway.app/dashboard
2. 选择你的项目
3. 点击 **语音服务**（mindflow-voice-service）
4. 进入 **Settings** 标签
5. 找到 **Networking** 部分
6. 如果没有域名，点击 **Generate Domain**
7. 复制生成的 URL，例如：
   ```
   https://mindflow-voice-service.up.railway.app
   ```

#### 1.2 获取 GPT-5 服务地址

1. 在同一个 Railway 项目中
2. 点击 **GPT-5 服务**（mindflow-gpt5-service）
3. 进入 **Settings → Networking**
4. 点击 **Generate Domain**（如果还没生成）
5. 复制 URL，例如：
   ```
   https://mindflow-gpt5-service.up.railway.app
   ```

---

### 步骤2：在 Vercel 配置环境变量

#### 2.1 打开 Vercel 控制台

1. 访问：https://vercel.com/dashboard
2. 找到并点击你的项目：`mindflow-agent`

#### 2.2 添加环境变量

1. 点击 **Settings** 标签
2. 左侧菜单选择 **Environment Variables**
3. 点击页面右上角的 **Add New**

#### 2.3 添加语音服务 URL

```
Key: NEXT_PUBLIC_VOICE_SERVER_URL
Value: https://mindflow-voice-service.up.railway.app

Select Environments:
☑️ Production
☑️ Preview  
☑️ Development
```

点击 **Save**

#### 2.4 添加 GPT-5 服务 URL

再次点击 **Add New**：

```
Key: NEXT_PUBLIC_GPT5_SERVER_URL
Value: https://mindflow-gpt5-service.up.railway.app

Select Environments:
☑️ Production
☑️ Preview
☑️ Development
```

点击 **Save**

#### 2.5 确认环境变量

应该能看到列表中有：

```
NEXT_PUBLIC_VOICE_SERVER_URL    https://mindflow-voice-service.up.railway.app
NEXT_PUBLIC_GPT5_SERVER_URL     https://mindflow-gpt5-service.up.railway.app
OPENAI_API_KEY                  sk-proj-***
BLOB_READ_WRITE_TOKEN           vercel_blob_***
...
```

---

### 步骤3：重新部署 Vercel

环境变量修改后**必须重新部署**才能生效！

#### 3.1 进入 Deployments 页面

1. 在 Vercel 项目页面，点击 **Deployments** 标签
2. 看到最新的部署（最上面那一行）

#### 3.2 触发重新部署

1. 点击该部署右侧的 **三个点 (...)** 按钮
2. 在下拉菜单中选择 **Redeploy**
3. 在弹出的确认对话框中，勾选：
   ```
   ☑️ Use existing Build Cache
   ```
4. 点击 **Redeploy** 按钮

#### 3.3 等待部署完成

- 通常需要 1-2 分钟
- 观察部署状态变为 **Ready**
- 复制新的部署 URL

---

### 步骤4：验证连接

#### 4.1 访问前端

打开浏览器访问：
```
https://mindflow-agent-eg85clpg7-wosunheizhus-projects.vercel.app
```

或者 Vercel 分配的新域名。

#### 4.2 打开浏览器控制台

按 **F12** 打开开发者工具，切换到 **Console** 标签。

#### 4.3 检查环境变量

在控制台输入并运行：

```javascript
console.log('语音服务URL:', window.location.origin);
// 然后查看页面源代码或 Network 请求，确认连接的后端地址
```

#### 4.4 测试数字员工功能

1. 在聊天页面，确保 **数字员工** 开关已打开
2. 发送一条消息，例如："你好"
3. 观察：
   - ✅ 是否有语音播报
   - ✅ 数字员工头像是否说话
   - ✅ 控制台是否有错误

**在 Network 标签查看**：
- 应该能看到请求发送到：`https://mindflow-voice-service.up.railway.app`

#### 4.5 测试 GPT-5 深度思考

1. 选择模型：**Mindflow-Y-Pro** 或 **Mindflow-Y**
2. 打开 **深度思考** 开关，设置为 **High**
3. 发送问题，例如："解释量子计算原理"
4. 观察：
   - ✅ 是否显示蓝色的"Agentic AI 推理过程"框
   - ✅ 推理内容是否流式显示
   - ✅ 控制台是否有错误

**在 Network 标签查看**：
- 应该能看到请求发送到 `/api/chat`
- 该请求会调用 GPT-5 服务

#### 4.6 测试文件下载

1. 发送："帮我生成一个数据图表"
2. 等待 AI 生成
3. 检查下载链接：
   - ✅ Vercel Blob 链接应该显示为**蓝色下载按钮**
   - ✅ 点击应该能下载文件

**控制台调试输出**：
```
🔗 链接分类结果：
  总链接数: 1
  - https://...blob.vercel-storage.com/...html => ✅ 下载
  下载链接: Array(1)
  普通链接: Array(0)
```

---

## 🧪 完整测试命令

在浏览器控制台运行以下测试：

```javascript
// 测试1：检查 Vercel Blob 链接识别
const testUrl = "https://9ki2eqxjajyfqr83.public.blob.vercel-storage.com/downloads/4packaxodmgmhhvz8ui/bar_chart_1762098547338.html";

// 判断逻辑（模拟）
const isDownload = 
  testUrl.includes('/api/download') || 
  /\/downloads?[?\/]/i.test(testUrl) ||
  testUrl.includes('.blob.vercel-storage.com');

console.log('测试链接:', testUrl);
console.log('是否为下载链接:', isDownload);  // 应该是 true
```

---

## 📊 完整架构图（含连接）

```
┌────────────────────────────────────────────────┐
│  Vercel 前端                                    │
│  https://mindflow-agent-xxx.vercel.app         │
│                                                │
│  环境变量:                                     │
│  • NEXT_PUBLIC_VOICE_SERVER_URL → Railway #1  │
│  • NEXT_PUBLIC_GPT5_SERVER_URL → Railway #2   │
│  • BLOB_READ_WRITE_TOKEN → Vercel Blob        │
└────────────────────────────────────────────────┘
         ↓                        ↓
    调用语音服务              调用 GPT-5 服务
         ↓                        ↓
┌──────────────────────┐  ┌──────────────────────┐
│ Railway 语音服务      │  │ Railway GPT-5 服务    │
│ voice_server.py      │  │ gpt5_service.py      │
│ :8001                │  │ :8002                │
│                      │  │                      │
│ 环境变量:            │  │ 环境变量:            │
│ • ARK_API_KEY        │  │ • OPENAI_API_KEY     │
│ • DOUBAO_API_KEY     │  │ • OPENAI_BASE_URL    │
│ • XFYUN_*            │  │                      │
└──────────────────────┘  └──────────────────────┘
```

---

## ✅ 验证清单

完成以下所有项，确保连接成功：

### Railway 服务
- [ ] 语音服务日志显示：`Uvicorn running on http://0.0.0.0:8001`
- [ ] GPT-5 服务日志显示：`Uvicorn running on http://0.0.0.0:8002`
- [ ] 两个服务都生成了公网域名
- [ ] 使用 `curl` 测试两个服务都能访问

### Vercel 配置
- [ ] 环境变量 `NEXT_PUBLIC_VOICE_SERVER_URL` 已添加
- [ ] 环境变量 `NEXT_PUBLIC_GPT5_SERVER_URL` 已添加
- [ ] 环境变量值以 `https://` 开头，不以 `/` 结尾
- [ ] 已重新部署 Vercel

### 功能测试
- [ ] 前端页面能正常访问
- [ ] AI 聊天功能正常
- [ ] 数字员工有语音播报
- [ ] 深度思考显示推理过程
- [ ] 文件生成和下载正常
- [ ] **Vercel Blob 链接显示为蓝色下载按钮**（已修复）

---

## 🔍 故障排查

### 如果数字员工没声音

```bash
# 1. 检查语音服务是否在线
curl https://你的语音服务URL/health

# 2. 检查 Vercel 环境变量
# 在 Vercel 控制台确认 NEXT_PUBLIC_VOICE_SERVER_URL 正确

# 3. 确认已重新部署 Vercel
```

### 如果深度思考不显示

```bash
# 1. 检查 GPT-5 服务是否在线
curl https://你的GPT5服务URL/

# 2. 检查 OpenAI API Key 是否有效
# 在 Railway GPT-5 服务的环境变量中确认

# 3. 查看 Railway GPT-5 服务日志
# 看是否有 API 调用错误
```

### 如果下载链接仍显示为参考链接

1. **刷新页面**（已修复代码，需要重新加载）
2. **清除缓存**：Cmd+Shift+R（Mac）或 Ctrl+Shift+R（Windows）
3. **查看控制台**：
   ```
   🔗 链接分类结果：
   - https://...blob.vercel-storage.com/... => ✅ 下载
   ```

---

## 🎯 修复说明

### 下载链接识别已优化

**现在支持**：
1. ✅ `/api/download` 路径
2. ✅ `/download/` 路径
3. ✅ `/downloads/` 路径（新增）
4. ✅ `.blob.vercel-storage.com` 域名（新增）
5. ✅ `.html` 文件扩展名（新增）

**你的链接**：
```
https://9ki2eqxjajyfqr83.public.blob.vercel-storage.com/downloads/xxx/bar_chart_xxx.html
                                                         ↑        ↑
                                          包含 /downloads/    以 .html 结尾
```

现在会被正确识别为**下载链接**，显示为蓝色下载按钮！

---

## 🚀 立即生效

**刷新前端页面**，下载链接就会正确显示了！

如果要应用到生产环境：

```bash
# 提交修复
git add components/Linkify.tsx
git commit -m "fix: 修复 Vercel Blob 链接识别"
git push origin main

# Vercel 会自动重新部署（如果配置了自动部署）
# 或手动触发重新部署
```

---

**现在前后端应该完全连接好了！** 🎉

需要帮你测试哪个功能吗？


