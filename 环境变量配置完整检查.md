# 🔍 环境变量配置完整检查清单

## ⚠️ 发现的问题

您的错误显示仍在访问 `localhost:8001`，说明环境变量没有生效。

---

## 📋 完整的环境变量配置

### Vercel 需要配置（共5个）

#### 必需的：

1. **OPENAI_API_KEY**
   ```
   值: sk-proj-你的实际密钥
   环境: ☑ Production ☑ Preview ☑ Development
   ```

2. **BRAVE_API_KEY**
   ```
   值: 你的实际密钥
   环境: ☑ Production ☑ Preview ☑ Development
   ```

3. **VOICE_SERVER_URL** （服务端API使用）
   ```
   值: https://web-production-7bbc1.up.railway.app
   环境: ☑ Production ☑ Preview ☑ Development
   ```

4. **NEXT_PUBLIC_VOICE_SERVER_URL** （客户端组件使用）⭐ 最关键
   ```
   值: https://web-production-7bbc1.up.railway.app
   环境: ☑ Production ☑ Preview ☑ Development
   ```

#### 可选的：

5. **ARK_API_KEY**
   ```
   值: 你的豆包密钥
   环境: ☑ Production ☑ Preview ☑ Development
   ```

---

### Railway 需要配置（共3个）

#### 必需的：

1. **ARK_API_KEY**
   ```
   值: 你的豆包密钥
   ```

2. **PYTHONUNBUFFERED**
   ```
   值: 1
   ```

3. **FRONTEND_URL** ⭐ 解决CORS
   ```
   值: https://mindflow-agent.com
   ```

---

## 🔍 为什么需要 NEXT_PUBLIC_ 前缀？

Next.js 中：
- **服务端代码**（API Routes）：可以用 `process.env.VOICE_SERVER_URL`
- **客户端代码**（组件）：必须用 `process.env.NEXT_PUBLIC_VOICE_SERVER_URL`

您的 `AvatarDisplay.tsx` 是客户端组件，所以需要 `NEXT_PUBLIC_` 前缀！

---

## ✅ 操作步骤

### 步骤1：在 Vercel 添加变量

1. https://vercel.com/dashboard
2. 项目 → Settings → Environment Variables
3. 点击 **Add New**
4. 名称：`NEXT_PUBLIC_VOICE_SERVER_URL`
5. 值：`https://web-production-7bbc1.up.railway.app`
6. 勾选：☑ Production ☑ Preview ☑ Development
7. 点击 **Save**

### 步骤2：在 Railway 确认变量

1. https://railway.app/dashboard
2. 项目 → Variables
3. 确认这3个变量存在：
   - ARK_API_KEY
   - PYTHONUNBUFFERED (值为 1)
   - FRONTEND_URL (值为 https://mindflow-agent.com)

如果 FRONTEND_URL 不存在，添加它！

### 步骤3：重新部署

**Vercel**：
- Deployments → 最新部署 → ⋯ → Redeploy

**Railway**（添加 FRONTEND_URL 后会自动重启）

---

## 🔍 验证配置

### 在 Vercel Deployments 页面

部署完成后，点击部署 → **Function Logs**，查看日志。

**正确的日志**：
```
Using VOICE_SERVER_URL: https://web-production-7bbc1.up.railway.app
```

**错误的日志**：
```
Using VOICE_SERVER_URL: http://localhost:8001
```

---

## 🐛 其他可能的问题

### 问题1：Railway CORS 配置

检查 voice_server.py 是否正确读取 FRONTEND_URL：

```python
frontend_url = os.getenv("FRONTEND_URL")
if frontend_url:
    allowed_origins.append(frontend_url)
```

这个逻辑已经在代码中，但需要确保 Railway 的环境变量已设置。

### 问题2：缓存问题

**清除浏览器缓存**：
- Chrome：Cmd+Shift+Delete
- 或使用隐身模式测试

### 问题3：部署未完成

确保：
- Vercel 部署状态显示 "Ready" ✓
- Railway 服务状态显示 "Active" ✓

---

## 📊 完整检查清单

### Vercel 配置
- [ ] OPENAI_API_KEY 已添加
- [ ] BRAVE_API_KEY 已添加
- [ ] VOICE_SERVER_URL 已添加
- [ ] **NEXT_PUBLIC_VOICE_SERVER_URL 已添加** ⭐
- [ ] 所有变量都勾选了3个环境
- [ ] 已点击 Redeploy
- [ ] 部署状态显示 Ready

### Railway 配置
- [ ] ARK_API_KEY 已添加
- [ ] PYTHONUNBUFFERED=1 已添加
- [ ] **FRONTEND_URL 已添加** ⭐
- [ ] 服务状态显示 Active

### 测试
- [ ] 访问 https://mindflow-agent.com
- [ ] AI对话功能正常
- [ ] 数字员工语音功能正常
- [ ] 浏览器控制台无CORS错误

---

## 🎯 关键点

**最重要的2个配置**：
1. Vercel: `NEXT_PUBLIC_VOICE_SERVER_URL` = Railway URL
2. Railway: `FRONTEND_URL` = Vercel URL

配置这2个后，CORS问题就能解决！

---

**现在去检查并配置这些变量吧！** 🚀

