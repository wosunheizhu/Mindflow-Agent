# 数字员工双重总结问题分析与修复

## 问题描述

数字员工会总结两次 Agent 的生成结果：

```
小岚：马上处理
小岚：Agentic AI刚才尝试搜索2024-2025 Agent系统最新发展，不过搜索服务暂时不可用，重试3次都失败了。
小岚：老板，Agentic AI尝试搜索"2024-2025 AI agent systems advancements"，但搜索服务失败了，还显示已重试3次呢。
```

## 根本原因

在 `app/chat/page.tsx` 中有两处代码都在处理 `avatar_audio` 事件并发送 `avatar_summary`：

### 第一处（379-411行）- handleSubmitFromAvatar 函数
```typescript
} else if (parsed.type === 'avatar_audio') {
  // 数字员工总结完成
  console.log(`🎤 [数字员工任务] 数字员工总结完成...`);
  
  // 通知数字员工组件显示总结消息
  if (parsed.summaryText && parsed.summaryText.trim()) {
    window.dispatchEvent(new CustomEvent('agent_avatar_message', {
      detail: {
        type: 'avatar_summary', 
        text: parsed.summaryText.trim(),
        voice: currentVoice
      }
    }));
  }
}
```

### 第二处（626-648行）- handleSend 函数
```typescript
} else if (parsed.type === 'avatar_audio') {
  // LLM-TTS双向流式完成（第二次回答），静默播放音频
  console.log(`🎤 数字员工总结完成...`);
  
  // 通知数字员工组件显示总结消息
  if (parsed.summaryText && parsed.summaryText.trim()) {
    window.dispatchEvent(new CustomEvent('agent_avatar_message', {
      detail: {
        type: 'avatar_summary', 
        text: parsed.summaryText.trim(),
        voice: currentVoice
      }
    }));
  }
}
```

## 问题分析

当数字员工触发任务时：
1. 用户通过数字员工对话框发送消息
2. 数字员工生成带 `{提示词}` 的回复
3. 前端检测到提示词，触发 `avatar_agent_task` 事件
4. **事件被两个地方同时监听**：
   - handleSubmitFromAvatar（通过事件监听器）
   - handleSend（可能也被触发？）

结果：同一个 `avatar_audio` 事件被处理了两次，导致发送了两次 `avatar_summary`。

## 搜索服务问题

从错误信息 "搜索服务暂时不可用，重试3次都失败了" 可以看出：

1. **Brave Search API 配置问题**
   - 可能没有配置 `BRAVE_API_KEY`
   - 或者 API Key 无效/超额
   - 或者网络连接问题

2. **当前使用的工具文件**: `lib/tools-complete.ts`
   - 已经有重试机制（3次）
   - 超时设置：15秒

## 修复方案

### 修复 1: 解决双重总结问题

**方案A（推荐）**：检查事件来源，避免重复处理
```typescript
// 在其中一个处理函数中添加标记
let avatarAudioProcessed = false;

if (parsed.type === 'avatar_audio' && !avatarAudioProcessed) {
  avatarAudioProcessed = true;
  // 处理逻辑...
}
```

**方案B**：删除重复的事件处理代码
- 只保留一个地方处理 `avatar_audio`
- 建议保留 `handleSubmitFromAvatar` 中的处理，删除 `handleSend` 中的

### 修复 2: 解决搜索服务问题

**步骤1**：检查环境变量配置
```bash
# 检查 .env.local 文件
cat .env.local | grep BRAVE_API_KEY
```

**步骤2**：如果没有配置，需要获取 API Key
- 访问 https://brave.com/search/api/
- 注册并获取 API Key
- 添加到 `.env.local`:
  ```
  BRAVE_API_KEY=your_api_key_here
  ```

**步骤3**：如果已配置但仍失败，检查：
- API Key 是否有效
- 是否超过配额限制
- 网络是否可访问 https://api.search.brave.com

**步骤4（备选）**：使用其他搜索API
- DuckDuckGo（免费，无需API Key）
- Google Custom Search（需要配置）

## 建议的代码修改

删除 `handleSend` 函数中的重复代码（626-648行）：

```typescript
// 删除这段代码
} else if (parsed.type === 'avatar_audio') {
  // 这段代码是重复的，会导致双重总结
  // ...
}
```

或者添加去重逻辑：

```typescript
// 在文件顶部添加
let lastProcessedAudioTimestamp = 0;

// 在处理 avatar_audio 时
} else if (parsed.type === 'avatar_audio') {
  const now = Date.now();
  if (now - lastProcessedAudioTimestamp < 1000) {
    console.log('⏭️ 跳过重复的 avatar_audio 事件');
    return;
  }
  lastProcessedAudioTimestamp = now;
  
  // 正常处理逻辑...
}
```

## 验证步骤

修复后，测试流程：
1. 对数字员工说："帮我搜索AI技术"
2. 数字员工应该只显示一次总结（不是两次）
3. 如果搜索成功，应该返回搜索结果
4. 如果搜索失败，应该清楚说明原因

## 优先级

1. **高优先级**：修复双重总结问题
2. **中优先级**：配置 Brave Search API
3. **低优先级**：优化错误提示


